const REQ_TASKADD = {"contentLength":459,
                     "parameters":{"api_app_id":["A01FHT06G10"],"user_id":["U9ST58P4L"],"team_id":["T9S90TNQG"],"team_domain":["ssi-sjnk"],"response_url":["https://hooks.slack.com/commands/T9S90TNQG/1547098575201/Kof9PeXlYT5isqyzTs0hBK7C"],"user_name":["yasuzuki"],"token":["IXiKaPt7YtUNoQ1JooAALVfy"],"channel_id":["D01FHU04CBC"],"channel_name":["directmessage"],"text":["”これこれをやる\""],"trigger_id":["1519727772535.332306940832.692bea9cd8e5f83c0536e893588c989a"],"command":["/taskadd"]},
                     "queryString":"",
                     "postData":{"contents":"token=IXiKaPt7YtUNoQ1JooAALVfy&team_id=T9S90TNQG&team_domain=ssi-sjnk&channel_id=D01FHU04CBC&channel_name=directmessage&user_id=U9ST58P4L&user_name=yasuzuki&command=%2Ftaskadd&text=%E2%80%9D%E3%81%93%E3%82%8C%E3%81%93%E3%82%8C%E3%82%92%E3%82%84%E3%82%8B%22&api_app_id=A01FHT06G10&response_url=https%3A%2F%2Fhooks.slack.com%2Fcommands%2FT9S90TNQG%2F1547098575201%2FKof9PeXlYT5isqyzTs0hBK7C&trigger_id=1519727772535.332306940832.692bea9cd8e5f83c0536e893588c989a","length":459,"name":"postData","type":"application/x-www-form-urlencoded"},
                     "contextPath":"",
                     "parameter":{"api_app_id":"A01FHT06G10","text":"”11/2 #123456 これこれをやる\"","team_domain":"ssi-sjnk","token":"IXiKaPt7YtUNoQ1JooAALVfy","trigger_id":"1519727772535.332306940832.692bea9cd8e5f83c0536e893588c989a","channel_id":"D01FHU04CBC","team_id":"T9S90TNQG","response_url":"https://hooks.slack.com/commands/T9S90TNQG/1547098575201/Kof9PeXlYT5isqyzTs0hBK7C","command":"/taskadd","user_id":"U9ST58P4L","user_name":"yasuzuki","channel_name":"directmessage"}};
const REQ_TASKASSIGN = {"contentLength":459,
                     "parameters":{"api_app_id":["A01FHT06G10"],"user_id":["U9ST58P4L"],"team_id":["T9S90TNQG"],"team_domain":["ssi-sjnk"],"response_url":["https://hooks.slack.com/commands/T9S90TNQG/1547098575201/Kof9PeXlYT5isqyzTs0hBK7C"],"user_name":["yasuzuki"],"token":["IXiKaPt7YtUNoQ1JooAALVfy"],"channel_id":["D01FHU04CBC"],"channel_name":["directmessage"],"text":["”これこれをやる\""],"trigger_id":["1519727772535.332306940832.692bea9cd8e5f83c0536e893588c989a"],"command":["/taskadd"]},
                     "queryString":"",
                     "postData":{"contents":"token=IXiKaPt7YtUNoQ1JooAALVfy&team_id=T9S90TNQG&team_domain=ssi-sjnk&channel_id=D01FHU04CBC&channel_name=directmessage&user_id=U9ST58P4L&user_name=yasuzuki&command=%2Ftaskadd&text=%E2%80%9D%E3%81%93%E3%82%8C%E3%81%93%E3%82%8C%E3%82%92%E3%82%84%E3%82%8B%22&api_app_id=A01FHT06G10&response_url=https%3A%2F%2Fhooks.slack.com%2Fcommands%2FT9S90TNQG%2F1547098575201%2FKof9PeXlYT5isqyzTs0hBK7C&trigger_id=1519727772535.332306940832.692bea9cd8e5f83c0536e893588c989a","length":459,"name":"postData","type":"application/x-www-form-urlencoded"},
                     "contextPath":"",
                     "parameter":{"api_app_id":"A01FHT06G10","text":"t0002 @member_a @member_b","team_domain":"ssi-sjnk","token":"IXiKaPt7YtUNoQ1JooAALVfy","trigger_id":"1519727772535.332306940832.692bea9cd8e5f83c0536e893588c989a","channel_id":"D01FHU04CBC","team_id":"T9S90TNQG","response_url":"https://hooks.slack.com/commands/T9S90TNQG/1547098575201/Kof9PeXlYT5isqyzTs0hBK7C","command":"/taskassign","user_id":"U9ST58P4L","user_name":"yasuzuki","channel_name":"directmessage"}};

const REQ_PROCESS_RESPONSE = {
    "postData":
       {"contents":"payload=%7B%22type%22%3A%22interactive_message%22%2C%22actions%22%3A%5B%7B%22name%22%3A%22eng%22%2C%22type%22%3A%22button%22%2C%22value%22%3A%22language%22%7D%5D%2C%22callback_id%22%3A%22callback_button%22%2C%22team%22%3A%7B%22id%22%3A%22T9S90TNQG%22%2C%22domain%22%3A%22ssi-sjnk%22%7D%2C%22channel%22%3A%7B%22id%22%3A%22D01FHU04CBC%22%2C%22name%22%3A%22directmessage%22%7D%2C%22user%22%3A%7B%22id%22%3A%22U9ST58P4L%22%2C%22name%22%3A%22yasuzuki%22%7D%2C%22action_ts%22%3A%221606567830.747366%22%2C%22message_ts%22%3A%221606567823.001200%22%2C%22attachment_id%22%3A%221%22%2C%22token%22%3A%22IXiKaPt7YtUNoQ1JooAALVfy%22%2C%22is_app_unfurl%22%3Afalse%2C%22response_url%22%3A%22https%3A%5C%2F%5C%2Fhooks.slack.com%5C%2Factions%5C%2FT9S90TNQG%5C%2F1531289099045%5C%2F0xGDGGzizQXd6mzebj3MCfG6%22%2C%22trigger_id%22%3A%221558219227760.332306940832.77c7ec89656df11f40b071a8cb042d6f%22%7D",
    "length":881,
    "name":"postData",
    "type":"application/x-www-form-urlencoded"},
    "contentLength":881,
    "contextPath":"",
    "queryString":"",
    "parameter":{"payload":`{"type":"interactive_message","actions":[{"name":"eng","type":"button","value":"language"}],"callback_id":"callback_button","team":{"id":"T9S90TNQG","domain":"ssi-sjnk"},"channel":{"id":"D01FHU04CBC","name":"directmessage"},"user":{"id":"U9ST58P4L","name":"yasuzuki"},"action_ts":"1606567830.747366","message_ts":"1606567823.001200","attachment_id":"1","token":"IXiKaPt7YtUNoQ1JooAALVfy","is_app_unfurl":false,"response_url":"https://hooks.slack.com/actions/T9S90TNQG/1531289099045/0xGDGGzizQXd6mzebj3MCfG6","trigger_id":"1558219227760.332306940832.77c7ec89656df11f40b071a8cb042d6f"}`},
    "parameters":{"payload":[`{"type":"interactive_message","actions":[{"name":"eng","type":"button","value":"language"}],"callback_id":"callback_button","team":{"id":"T9S90TNQG","domain":"ssi-sjnk"},"channel":{"id":"D01FHU04CBC","name":"directmessage"},"user":{"id":"U9ST58P4L","name":"yasuzuki"},"action_ts":"1606567830.747366","message_ts":"1606567823.001200","attachment_id":"1","token":"IXiKaPt7YtUNoQ1JooAALVfy","is_app_unfurl":false,"response_url":"https://hooks.slack.com/actions/T9S90TNQG/1531289099045/0xGDGGzizQXd6mzebj3MCfG6","trigger_id":"1558219227760.332306940832.77c7ec89656df11f40b071a8cb042d6f"}`]}
    };

function testtaskadd(){
  CacheService.getScriptCache().remove(DEF_COLUMN_TASK);
  var data = REQ_TASKADD;
  var ret = doPost(data);
  console.log(ret.getContent());
}

function testupdateTask(){
  CacheService.getScriptCache().remove(DEF_COLUMN_TASK);
  var data = REQ_TASKASSIGN;
  var ret = doPost(data);
  console.log(ret.getContent());
} 


function testInvalid(){
  var data = {"data":"Invalid data"};
  var ret = doPost(data);
  console.log(ret.getContent());
}



function testprocessResponse(e){
  var data = REQ_PROCESS_RESPONSE;
  var ret = doPost(data);
  console.log(ret.getContent());
}
function doPost(e) {
  try {
    var req = parseRequestFromSlack(e);
    return processRequest(req);
  } catch (exception) {
    console.log("問題発生：file:[" + exception.fileName + ']: line[' + exception.lineNumber + ']\nname[' + exception.name + ']: message[' + exception.message + ']\n' + exception.stack);
    return buildErrorResponse(exception.message + "\n" + exception.stack); //messageにSlack用の返答メッセージが設定されているはず　 
  }
}


function taskadd(req){var data = {text:"taskadd",response_type:"ephemeral"}; return buildResponse(data);}
function taskaddchild(req){var data = {text:"taskaddchild",response_type:"ephemeral"}; return buildResponse(data);}
function taskupdate(req){var data = {text:"taskupdate",response_type:"ephemeral"}; return buildResponse(data);}
function taskdelete(req){var data = {text:"taskdelete",response_type:"ephemeral"}; return buildResponse(data);}
function taskassign(req){var data = {text:"taskassign",response_type:"ephemeral"}; return buildResponse(data);}

function taskclose(req){var data = {text:"taskclose",response_type:"ephemeral"}; return buildResponse(data);}
function taskstart(req){var data = {text:"taskstart",response_type:"ephemeral"}; return buildResponse(data);}                 
function taskstop(req){var data = {text:"taskstop",response_type:"ephemeral"}; return buildResponse(data);}
function taskcomment(req){var data = {text:"taskcomment",response_type:"ephemeral"}; return buildResponse(data);}


function parseRequestFromSlack(e){
  var req = {};


  if ( hasNestedKey(e,"parameter","command")) {
    //commandがあればスラッシュコマンドと判定
    req["command"] = e.parameter.command;
    //tokenは必須。なければエラー
    if ( hasNestedKey(e,"parameter","token")) { 
      req["token"] = e.parameter.token;
    } else {
      throw new Error("問題発生: parameter.tokenパラメータが未設定");
    }
    //スラッシュコマンドではuser_nameはparameter直下
    if ( hasNestedKey(e,"parameter","user_name") && hasNestedKey(e,"parameter","user_id")) { 
      req["user"] = { id:e.parameter.user_id, name: e.parameter.user_name} ;
    } else {
      throw new Error("問題発生: parameter.user_naemパラメータが未設定");
    }
    //スラッシュコマンドのパラメータは任意。ただし、スラッシュコマンド次第では必須チェックあり。その場合は後でチェックする
    if ( hasNestedKey(e,"parameter","text") ) {
      req["text"] = e.parameter.text;
    } else {
      req["text"] = null;
    }
  } else if ( hasNestedKey(e, "parameter","payload") && typeof e.parameter.payload == "string" ) {
    //payloadがあればSlackインタラクティブコンポーネントによる返答と判定
    var payload = JSON.parse(e.parameter.payload);
    req["interactive"] = true;
    //tokenは必須。なければエラー
    if ( hasNestedKey(payload,"token")) { 
      req["token"] = payload.token;
    } else {
      throw new Error("問題発生: e.parameter.payload.tokenパラメータが未設定");
    }
    if ( "actions" in payload && payload.actions instanceof Array && "name" in payload.actions[0] ) {
      req["actions"] = payload.actions; 
    } else {
      throw new Error("問題発生: e.parameter.payload.actions[0].nameパラメータが未設定");
    }
    //Slackインタラクティブコンポーネントによる返答ではuser_nameはuser連想配列の配下
    if ( hasNestedKey(payload,"user","id") &&  hasNestedKey(payload,"user","name") ) {
      req["user"] = payload.user;
    } else {
      throw new Error("問題発生: e.parameter.payload.userパラメータが未設定");
    }
  }
  return req;
}

function processRequest(req) {
  var SLACK_APP_TOKEN_OFFICE = '5qMKPEFIIGSieQvQwG5ba5kY'; //オフィス用 Verification Token
  var SLACK_APP_TOKEN_HOME = 'IXiKaPt7YtUNoQ1JooAALVfy';  //自宅用
  // 指定したチャンネルからの命令しか受け付けない
  updateLogSheet(JSON.stringify(req) );
  if ( ! ( SLACK_APP_TOKEN_HOME == req.token || SLACK_APP_TOKEN_OFFICE == req.token) ) {
    throw new Error("問題発生：アプリトークンが一致しません。予期しないアプリから呼び出しされました。");
  }
  //
  if ( req.command ) {
    //Slash Commandから呼ばれた場合    
    switch (req.command ) {
      case "/kintaistart":
        updateLogSheet("call kintaistart");
      return kintaistart(req);
      case "/kintaiend":
        updateLogSheet("call kintaiend");
        return kintaiend(req);
      case "/tasklist":
        updateLogSheet("call tasklist");
        return tasklist(req);
      case "/taskadd":
        updateLogSheet("call taskadd");
        return taskadd(req);        
      case "/taskaddchild":
        updateLogSheet("call taskaddchild");
        return taskaddchild(req);
      case "/taskupdate":
        updateLogSheet("call taskupdate");
        return taskupdate(req);
      case "/taskdelete":
        updateLogSheet("call taskdelete");
        return taskdelete(req);
      case "/taskassign":
        updateLogSheet("call taskassign");
        return taskassign(req);
      case "/taskack":
        updateLogSheet("call taskack");
        return taskack(req);
      case "/taskcomplete":
        updateLogSheet("call taskcomplete");
        return taskcomplete(req);
      case "/taskclose":
        updateLogSheet("call taskclose");
        return taskclose(req);
      case "/taskstart":
        updateLogSheet("call taskstart");
        return taskstart(req);                 
      case "/taskstop":
        updateLogSheet("call taskstop");
        return taskstop(req);
      case "/taskcomment":
        updateLogSheet("call taskcomment");
        return taskcomment(req);
      default:
        return buildErrorResponse("コマンドが見つかりません：" + req.parameter.command);
    }
                 
  }else if ( req.interactive ) {
    //interactive components から呼ばれた場合(type=interactive_message)、payloadはstring
    updateLogSheet("call processResponse: ");
    return processResponse(req); 
  } else{
    throw new Error("問題発生：アプリトークンが未設定");
  }
}

function kintaistart(req){
  insertUserActionLogSheet(req.user.name, "kinatistart");
  //TODO: req.text内のタスクは、”引受”したことにする
  var res = {text:"勤務開始了解しました！",response_type:"ephemeral"};
  return buildResponse(res);
}

function kintaiend(req){
  insertUserActionLogSheet(req.user.name, "kinatiend");
  var res = {text:"勤怠終了お疲れ様でした！！",response_type:"ephemeral"};
  return buildResponse(res);
}

function testtaskassign(){
  CacheService.getScriptCache().remove(COLUMN_DEF_TASK);
  var req = {text:"t0002 \n<@U9ST58P4L|yasutest>\n<@U9ST58P4L|yasuzuki>\n<@U9ST58P4L|yasutest>", user:{name:"admin"}};
  taskassign(req);
}
function taskassign(req){
  if ( req.text == null ) {throw new Error("問題発生：パラメータが未設定")}
  var taskID;
  var assign = [];
  var regexpRet = /^[\u{20}\u{3000}]*(t\d\d\d\d)/.exec(req.text);
  if ( regexpRet != null ) { taskID = regexpRet[1] }
  
  var regexp = /<@([0-9A-Z]+)/g;
  while ( (regexpRet = regexp.exec(req.text)) != null ) {
    assign[regexpRet[1]] = "依頼";
  }
  
  if ( taskID == null ) { throw new Error("問題発生：タスクIDが未設定")}
  if ( assign == null ) { throw new Error("問題発生：が未設定")}
  console.log("taskID:"+taskID+" assign:"+ JSON.stringify(assign));
  updateTask(taskID,assign );

  Object.keys(assign).forEach( function(e){
    var channelID = slackConversationOpenByUserID(e);
    slackSendMessageToChannel(channelID, "タスクID:[" + taskID　+ "]があなたに[" + assign[e] +"]されました");
  }); 
  
  insertUserActionLogSheet(req.user.name, "taskassign", [taskID].concat(Object.keys(assign)));
  var res = {text:"タスク依頼を発信しました。",response_type:"ephemeral"};
  return buildResponse(res);
}

function processResponse(req){
  // 返答データ本体
  var name = req.user.name + "(" + req.user.id + ")";
  insertUserActionLogSheet( name, "stepTwo "+req.actions[0].name);
  var data = {
    "text": "処理成功 " + req.actions[0].name,
    "response_type":"ephemeral"
  };
  return buildResponse(data); 
}
function getAccesstoken() {Logger.log(ScriptApp.getOAuthToken())} // DriveApp.getFiles()

function taskadd(req){
  if ( req.text == null ) {
    throw new Error("問題発生：textパラメータが未設定");
  }

  //タスクを追加し、採番されたタスクIDを受け取る
  var dueDate = extractDueDate(req.text);
  var redmine = extractRedmine(req.text);
  var mailSubject = req.text;
  var taskDispatcher = req.user.name;
  var newTaskRange = insertNewTask({状況:"着手指示待ち", 期日:dueDate, Redmine:redmine, メール件名:mailSubject, タスク依頼者:taskDispatcher});
  var taskID = newTaskRange.getCell(1,1).getValue();
  //ユーザアクションの履歴を残す
  insertUserActionLogSheet(req.user.name, "taskadd", [taskID]);

  //ユーザへ処理結果を返答する
  var res = {text:"タスク追加完了しました。タスクID["+taskID+"]",response_type:"ephemeral"};
  return buildResponse(res);
}




//メール件名などに含まれるタスクの期限を抽出する
function extractDueDate(text){
  var ret = null;
  var today = new Date();
  var parsedDate = null;
  var guessYear = function(dueMonth){if(new Date().getMonth() >= 9 && dueMonth <=2){return today.getFullYear()+1}else{return today.getFullYear()}}

  //あらかじめ全角を半角に返還しておく　https://www.yoheim.net/blog.php?q=20191101
  text = text.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);});
  
  //  "2020/11/25"形式
  ret = /\D(\d\d\d\d)\/(\d?\d)\/(\d?\d)\D/.exec(text);
  if ( parsedDate == null && ret != null ) { parsedDate = new Date(parseInt(ret[1]), parseInt(ret[2])-1, parseInt(ret[3])) }
  
  //  "11/25"形式
  ret = /\D(\d?\d)\/(\d?\d)\D/.exec(text);
  if (parsedDate == null && ret != null ) { parsedDate = new Date(guessYear(ret[1]), parseInt(ret[1])-1, parseInt(ret[2])) }

  //  "2020年11月25日"形式
  ret = /(\d\d\d\d)年(\d?\d)月(\d?\d)日/.exec(text);
  if ( parsedDate == null && ret != null ) { parsedDate = new Date(parseInt(ret[1]), parseInt(ret[2])-1, parseInt(ret[3])) }
  
  //  "11月25"形式
  ret = /(\d?\d)月(\d?\d)日/.exec(text);
  if ( parsedDate == null && ret != null ) { parsedDate = new Date(guessYear(ret[1]), parseInt(ret[1])-1, parseInt(ret[2]))}

  
  if ( parsedDate && parsedDate.toString() !== "Invalid Date") {  // 値が設定されていて、妥当な年月日の場合のみ真となる仕様
    return Utilities.formatDate(parsedDate, "Asia/Tokyo", "yyyy/MM/dd");
  } else {
    return "未定";
  }
  
}

//メール件名などに含まれるRedmine番号を抽出する
function extractRedmine(text){
  var ret = null;
  var parsedRedmine = null;

  //あらかじめ全角を半角に返還しておく　https://www.yoheim.net/blog.php?q=20191101
  text = text.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);});
  
  ret = /\#(\d?\d?\d\d\d\d)/.exec(text);
  if ( parsedRedmine == null && ret != null ) { parsedRedmine = "#"+ ret[1] }
  
  if ( parsedRedmine ) {
    return parsedRedmine;
  } else {
    return "未起票";
  }
  
}


//参考：
//https://officeforest.org/wp/2018/04/25/%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1%E3%81%A7google-apps-script%E3%82%92%E5%AE%89%E5%85%A8%E3%81%AB%E5%AE%9F%E8%A1%8C/
function insertNewTask(values){
  //ドキュメントロックを使用する
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000);  //最大30秒間のロックを取得
    var currentMaxID = PropertiesService.getScriptProperties().getProperty("nextTaskID");
    
    //アプリのバージョンアップなどでnextTaskIDがうまく取得できなかった場合は、
    //Excelシートを検索して現時点の最大タスクIDを抽出する
    if (currentMaxID == null) { currentMaxID = findMaxTaskID() }
    var nextMaxID = null;
    if ( /^[tT]/.test(currentMaxID) ) {
      var regexResult =  /^[tT](.*)/.exec(currentMaxID);
      nextID =  Utilities.formatString("t%04d", (parseInt(regexResult[1])+1));
    } else {
      throw new Exception("問題発生：次のタスクID採番に失敗しました");
    }
    PropertiesService.getScriptProperties().setProperty("nextTaskID",nextMaxID);
    var taskSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_TASK);
    var row = taskSheet.getLastRow()+1;
    values["タスクID"] = currentMaxID;
    var columns = translateHashToExcelRow(DEF_COLUMN_TASK,values);
    var taskRange = taskSheet.getRange(row, 1, 1, columns.length);
    taskRange.setValues([columns]);


    return taskRange;
  } catch (e) {
    throw new Error("問題発生：タスク追加処理に失敗しました"+e);　 
  }　finally　{
    lock.releaseLock();
  }
}

function updateTask(taskID, newValuesHash){
  //ドキュメントロックを使用する
  var lock = LockService.getScriptLock();
  var taskSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_TASK);

  try {
    lock.waitLock(30000);  //最大30秒間のロックを取得
    var taskRow = findRowByTaskID(taskID)
    if ( taskRow == null ) {
      throw new Error("エラー：指定したタスクIDがタスク管理簿に見つかりません");
    }
    var columnsLength = taskSheet.getLastColumn();
    var origArray = taskSheet.getRange(taskRow,1,1,columnsLength).getValues()[0];
    var columns = translateHashToExcelRow(DEF_COLUMN_TASK,newValuesHash,origArray);
    var taskRange = taskSheet.getRange(taskRow, 1, 1,columnsLength);
    taskRange.setValues([columns]);
    return taskRange;
  } catch (e) {
    throw new Error("問題発生：タスク更新処理に失敗しました." + e);　
  }　finally　{
    lock.releaseLock();
  }
}


//defシートに登録された要素をもとに、連想配列の値をExcelの行に変換する。
function translateHashToExcelRow(colDefTask, newValuesHash, origArray){
  var columnDef = getDefinitionFromCache(colDefTask);
  
  var array = null;
  if ( origArray != null ) {
    array = origArray;
  } else {
    array = new Array(Object.keys(columnDef).length);
  }
  
  for (var key in columnDef) {
    //データ更新の場合、newValuesHash内に存在する値だけを更新。それ以外は現状の値を維持
    if ( newValuesHash[key] != null ) {
      array[ parseInt(columnDef[key][0]) ] = newValuesHash[key];
    }
  }
  return array;
}



//Slackへの返却用のJSONフォーマットに変換
function buildResponse(json){
  return ContentService.createTextOutput(JSON.stringify(json)).setMimeType(ContentService.MimeType.JSON)
}

//Slackへの返却用のJSONフォーマットに変換
function buildErrorResponse(message){
  var data = {
    "text": "問題発生！", //アタッチメントではない通常メッセージ
    //"response_type":"ephemeral", // ここを"ephemeral"から"in_chanel"に変えると他の人にも表示されるらしい（？）
    //アタッチメント部分
    "attachments": [{
      "title": "原因：",//　アタッチメントのタイトル
      "text": message,//アタッチメント内テキスト
      "color": "#FF4F50", //左の棒の色を指定する
      "attachment_type": "default",
      }]
  };
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}



function TESTextractDueDate(){
  var ret = extractDueDate("なんちゃら11/25かんちゃら");
  if ( ret != "2020/11/25" ) {
    throw new Error("Test Fail: #1 ["+ret+"]");  
  }
  ret = extractDueDate("なんちゃら2020/11/25かんちゃら");
  if ( ret != "2020/11/25" ) {
    throw new Error("Test Fail: #2 ["+ret+"]");  
  }
  ret = extractDueDate("なんちゃら2020年11月25日かんちゃら");
  if ( ret != "2020/11/25" ) {
    throw new Error("Test Fail: #3 ["+ret+"]");  
  }
  ret = extractDueDate("なんちゃら11月25日かんちゃら");
  if ( ret != "2020/11/25" ) {
    throw new Error("Test Fail: #4 ["+ret+"]");  
  }
  ret = extractDueDate("なんちゃら1/25かんちゃら");
  if ( ret != "2021/01/25" ) {
    throw new Error("Test Fail: #5 ["+ret+"]");  
  }
  ret = extractDueDate("なんちゃら2021/1/25かんちゃら");
  if ( ret != "2021/01/25" ) {
    throw new Error("Test Fail: #5 ["+ret+"]");  
  } 
  
  ret = extractDueDate("なんちゃら２０２０/１１/２５かんちゃら");
  if ( ret != "2020/11/25" ) {
    throw new Error("Test Fail: #6 ["+ret+"]");  
  }    
  

}

function TESTtranslateHashToArray(){
  CacheService.getScriptCache().remove("task");
  var data = {期日:"2020/12/20",Redmine:"#123456",メール件名:"あれやこれや",タスク依頼者:"Dさん"};
  var result = translateHashToExcelRow("col_def_task",data);
  console.log(result);
}

function TESTextractRedmine(){
  var ret = extractRedmine("なんちゃら#12345かんちゃら");
  if ( ret != "#12345" ) {
    throw new Error("Test Fail: #1 ["+ret+"]");  
  }
  ret = extractRedmine("なんちゃら#123456かんちゃら");
  if ( ret != "#123456" ) {
    throw new Error("Test Fail: #2 ["+ret+"]");  
  }
  ret = extractRedmine("なんちゃら#１２３４５６かんちゃら");
  if ( ret != "#123456" ) {
    throw new Error("Test Fail: #3 ["+ret+"]");  
  }

}